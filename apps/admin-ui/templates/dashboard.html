<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governance Dashboard - Data Analyst Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="dashboard()" x-init="loadStats()">
        <!-- Navigation -->
        <nav class="bg-gray-800 border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-blue-400">üìä Governance Dashboard</span>
                    </div>
                    <div class="flex space-x-4">
                        <a href="/" class="text-blue-400 hover:text-blue-300 px-3 py-2">Dashboard</a>
                        <a href="/audit" class="text-gray-300 hover:text-white px-3 py-2">Audit Logs</a>
                        <a href="/policies" class="text-gray-300 hover:text-white px-3 py-2">Policies</a>
                        <a href="/approvals" class="text-gray-300 hover:text-white px-3 py-2">Approvals</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Total Requests -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-2">Total Requests (7d)</div>
                    <div class="text-3xl font-bold text-white" x-text="totalRequests"></div>
                </div>
                
                <!-- Allowed -->
                <div class="bg-gray-800 rounded-lg p-6 border border-green-900">
                    <div class="text-green-400 text-sm mb-2">‚úÖ Allowed</div>
                    <div class="text-3xl font-bold text-green-400" x-text="stats.decisions?.ALLOW || 0"></div>
                </div>
                
                <!-- Denied -->
                <div class="bg-gray-800 rounded-lg p-6 border border-red-900">
                    <div class="text-red-400 text-sm mb-2">‚ùå Denied</div>
                    <div class="text-3xl font-bold text-red-400" x-text="stats.decisions?.DENY || 0"></div>
                </div>
                
                <!-- Avg Latency -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-2">Avg Latency</div>
                    <div class="text-3xl font-bold text-white">
                        <span x-text="stats.avg_latency_ms || 0"></span>
                        <span class="text-lg text-gray-500">ms</span>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Tool Usage -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-medium mb-4">Tool Usage (7d)</h3>
                    <div class="space-y-4">
                        <template x-for="(count, tool) in stats.tools || {}" :key="tool">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span x-text="tool" class="text-gray-300"></span>
                                    <span x-text="count" class="text-gray-500"></span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" 
                                         :style="'width: ' + (count / maxToolCount * 100) + '%'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Denials -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-medium mb-4">Recent Denials (24h)</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <template x-for="denial in stats.recent_denials || []" :key="denial.timestamp">
                            <div class="bg-gray-700 rounded p-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-red-400" x-text="denial.tool"></span>
                                    <span class="text-gray-500" x-text="formatTime(denial.timestamp)"></span>
                                </div>
                                <div class="text-gray-400 text-sm mt-1" x-text="denial.user"></div>
                                <div class="text-gray-500 text-xs mt-1 truncate" x-text="denial.error"></div>
                            </div>
                        </template>
                        <div x-show="!stats.recent_denials?.length" class="text-gray-500 text-center py-4">
                            No denials in the last 24 hours üéâ
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-medium mb-4">Quick Actions</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <a href="/audit" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-center transition">
                        <div class="text-2xl mb-2">üìã</div>
                        <div class="text-sm">View Audit Logs</div>
                    </a>
                    <a href="/approvals" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-center transition">
                        <div class="text-2xl mb-2">üîê</div>
                        <div class="text-sm">Pending Approvals</div>
                    </a>
                    <a href="/policies" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-center transition">
                        <div class="text-2xl mb-2">üìú</div>
                        <div class="text-sm">View Policies</div>
                    </a>
                    <a href="/audit?decision=DENY" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-center transition">
                        <div class="text-2xl mb-2">üö´</div>
                        <div class="text-sm">View Denials</div>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        function dashboard() {
            return {
                stats: {},
                
                get totalRequests() {
                    const decisions = this.stats.decisions || {};
                    return Object.values(decisions).reduce((a, b) => a + b, 0);
                },
                
                get maxToolCount() {
                    const tools = this.stats.tools || {};
                    return Math.max(...Object.values(tools), 1);
                },
                
                async loadStats() {
                    try {
                        const response = await fetch('/api/stats');
                        this.stats = await response.json();
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                formatTime(isoString) {
                    return new Date(isoString).toLocaleTimeString();
                }
            };
        }
    </script>
</body>
</html>
